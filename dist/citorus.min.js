/*! citorus 2014-10-16 */
"use strict";function colour(a){_.each(a,function(a){a.div.show().css({outline:"1px solid lime","z-index":9999})})}function getPlace(a,b){var c=b?a.offset():a.position();return new Place({ux:c.left,uy:c.top,dx:c.left+a.outerWidth(),dy:c.top+a.outerHeight()})}function WinSize(){var a=0,b=0;"number"==typeof window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)&&(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight);var c=0,d=0;return"number"==typeof window.pageYOffset?(c=window.pageXOffset,d=window.pageYOffset):document.body&&(document.body.scrollLeft||document.body.scrollTop)?(c=document.body.scrollLeft,d=document.body.scrollTop):document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)&&(c=document.documentElement.scrollLeft,d=document.documentElement.scrollTop),{winHeight:b+d,winWidth:a+c}}function CMenu(){return this.items=[],this.left,this.jD=null,this}var minSize=200,Cord=function(a,b){if(a){var c=this instanceof HCord?"h":"v";this.id=++Cord._cordCounter,this.type=b||"thick",this.areaManager=a,this.div=$('<div id="cord-'+this.id+'" class="dotline dotline-'+c+'"></div>'),this.div.appendTo(a.div)}};Cord._cordCounter=0,Cord.prototype.set=function(a,b){if("x"===a||"y"===a){var c,d,e;if("x"===a){for(c={left:this.areaManager.findAreas("left",this),right:this.areaManager.findAreas("right",this)},d=b-this[a]<0?"right":"left",e=c[d].length;e--;)if(c[d][e].bounds.right.x-c[d][e].bounds.left.x<minSize)return!1}else for(c={top:this.areaManager.findAreas("top",this),bottom:this.areaManager.findAreas("bottom",this)},d=b-this[a]<0?"bottom":"top",e=c[d].length;e--;)if(c[d][e].bounds.bottom.y-c[d][e].bounds.top.y<minSize)return!1;this.areaManager.changeLinkedCords(this,b)}return this[a]=b,this.redraw(),!0},Cord.prototype.toJSON=function(){var a=this,b={type:this.type,id:this.id};return _.each(["ux","dx","uy","dy","x","y"],function(c){void 0!==a[c]&&(b[c]=a[c])}),b},Cord.prototype.remove=function(){this.areaManager[this.t()+"Cords"]=_.without(this.areaManager[this.t()+"Cords"],this),this.div.remove()};var VCord=function(a,b,c,d,e){Cord.call(this,a,e),this.x=b,this.uy=c,this.dy=d;var f,g,h=this;this.div.mousedown(function(a){g=!0,f=a.clientX}),$(document).mousemove("vCord",function(a){g&&h.set("x",h.x+a.clientX-f)&&(f=a.clientX)}),this.div.mouseup(function(){$(document).unbind("mousemove","vCord"),g=!1,h.finalRedraw()}),this.redraw()};VCord.prototype=new Cord,VCord.constructor=VCord,VCord.prototype.t=function(){return"v"},VCord.prototype.redraw=function(){var a=this.areaManager.findAreas("left",this).concat(this.areaManager.findAreas("right",this));this.div.css({left:this.x-2+"px",width:"5px",top:this.uy+"px",height:this.dy-this.uy+"px"}),"thin"===this.type&&this.div.css("display","none"),_.each(a,function(a){a.recalculatePosition()})},VCord.prototype.finalRedraw=function(){var a=this.areaManager.findAreas("left",this).concat(this.areaManager.findAreas("right",this));_.each(a,function(a){a.tabResize()})};var HCord=function(a,b,c,d,e){Cord.call(this,a,e),this.ux=b,this.dx=c,this.y=d;var f,g,h=this;this.div.mousedown(function(a){g=!0,f=a.clientY}),$(document).mousemove("hCord",function(a){g&&h.set("y",h.y+a.clientY-f)&&(f=a.clientY)}),this.div.mouseup(function(){$(document).unbind("mousemove","hCord"),g=!1}),this.redraw()};HCord.prototype=new Cord,HCord.constructor=HCord,HCord.prototype.t=function(){return"h"},HCord.prototype.redraw=function(){var a=this.areaManager.findAreas("top",this).concat(this.areaManager.findAreas("bottom",this));this.div.css({left:this.ux+"px",width:this.dx-this.ux+"px",top:this.y-2+"px",height:"5px"}),"thin"===this.type&&this.div.css("display","none"),_.each(a,function(a){a.recalculatePosition()})};var Place=function(a,b,c,d){void 0===b?(this.ux=a.ux,this.uy=a.uy,this.dx=a.dx,this.dy=a.dy):(this.ux=a,this.uy=b,this.dx=c,this.dy=d)};Place.prototype.clone=function(){return new Place(this.ux,this.uy,this.dx,this.dy)},Place.prototype.width=function(){return this.dx-this.ux},Place.prototype.height=function(){return this.dy-this.uy},Place.prototype.isEqual=function(a){return this.ux===a.ux&&this.uy===a.uy&&this.dx===a.dx&&this.dy===a.dy},Place.prototype.scale=function(a,b){return new Place(this.ux*a,this.uy*b,this.dx*a,this.dy*b)},Place.prototype.shift=function(a,b){return new Place(this.ux+a,this.uy+b,this.dx+a,this.dy+b)},Place.prototype.calculateHalf=function(a){var b,c=this.width(),d=this.height(),e=a.x-this.ux,f=a.y-this.uy,g=e>c-c*f/d,h=e>c*f/d;switch(b=h&&!g?1:h&&g?2:!h&&g?3:4){case 1:return new Place({ux:this.ux,uy:this.uy,dx:this.dx,dy:this.uy+d/2|0});case 2:return new Place({ux:this.ux+c/2|0,uy:this.uy,dx:this.dx,dy:this.dy});case 3:return new Place({ux:this.ux,uy:this.uy+d/2|0,dx:this.dx,dy:this.dy});case 4:return new Place({ux:this.ux,uy:this.uy,dx:this.ux+c/2|0,dy:this.dy});default:return this}},Place.prototype.calculateHalfs=function(a){var b,c=this.width(),d=this.height(),e=a.x-this.ux,f=a.y-this.uy,g=e>c-c*f/d,h=e>c*f/d,i=3;return h&&!g?(b=this.uy+d/2|0,{direction:"top",places:[new Place({ux:this.ux,uy:this.uy,dx:this.dx,dy:b-i}),new Place({ux:this.ux,uy:b+i,dx:this.dx,dy:this.dy}),new Place({ux:this.ux,uy:b-i+1,dx:this.dx,dy:b+i})]}):h&&g?(b=this.ux+c/2|0,{direction:"right",places:[new Place({ux:b+i,uy:this.uy,dx:this.dx,dy:this.dy}),new Place({ux:this.ux,uy:this.uy,dx:b-i,dy:this.dy}),new Place({ux:b-i+1,uy:this.uy,dx:b+i,dy:this.dy})]}):!h&&g?(b=this.uy+d/2|0,{direction:"bottom",places:[new Place({ux:this.ux,uy:b+i,dx:this.dx,dy:this.dy}),new Place({ux:this.ux,uy:this.uy,dx:this.dx,dy:b-i}),new Place({ux:this.ux,uy:b-i+1,dx:this.dx,dy:b+i})]}):(b=this.ux+c/2|0,{direction:"left",places:[new Place({ux:this.ux,uy:this.uy,dx:b-i,dy:this.dy}),new Place({ux:b+i,uy:this.uy,dx:this.dx,dy:this.dy}),new Place({ux:b-i+1,uy:this.uy,dx:b+i,dy:this.dy})]})},Place.prototype.toCSS=function(){return{left:this.ux+"px",top:this.uy+"px",width:this.dx-this.ux+"px",height:this.dy-this.uy+"px"}},Place.prototype.isClose=function(a){function b(a,b){return a.uy===b.dy&&(a.ux<=b.dx||b.ux<=a.dx)}function c(a,b){return a.ux===b.dx&&(a.uy<=b.dy||b.uy<=a.dy)}return b(this,a)||b(a,this)||c(this,a)||c(a,this)};var Shadow=function(a,b){if(b){var c=$(document.createElement("div")).appendTo(b.areaManager.div),d=this;this.areaManager=b.areaManager,c.css({"z-index":5,position:"absolute",width:"30px",height:"30px","background-color":"#CCC",left:a.clientX,top:a.clientY});var e=function(){$(document).unbind("mouseup",e).unbind("mousemove",f),c.remove(),d._split&&d.areaManager.placeArea(d._split,d.areaManager.what,b),delete d.areaManager.what,delete d._places,delete d._split},f=function(a){d._split=d.areaManager.findPlace(a.clientX,a.clientY),d._places=d._split.places;for(var b=d.areaManager.div.offset(),e=d._places.length;e--;)d._places[e].ux-=b.left,d._places[e].dx-=b.left,d._places[e].uy-=b.top,d._places[e].dy-=b.top;c.css(d._places[0].toCSS())};$(document).mouseup(e),$(document).mousemove(f)}},AreaManager=function(a){this.areas=[],this.dashboard=a,this.div=a.div,this.hCords=[],this.vCords=[]};AreaManager.prototype.findHCords=function(a,b,c){return{left:_.filter(this.hCords,function(d){return d.dx===a.x&&d.y>=(b||a.uy)&&d.y<=(c||a.dy)}),right:_.filter(this.hCords,function(d){return d.ux===a.x&&d.y>=(b||a.uy)&&d.y<=(c||a.dy)})}},AreaManager.prototype.findVCords=function(a,b,c){return{top:_.filter(this.vCords,function(d){return d.dy===a.y&&d.x>=(b||a.ux)&&d.x<=(c||a.dx)}),bottom:_.filter(this.vCords,function(d){return d.uy===a.y&&d.x>=(b||a.ux)&&d.x<=(c||a.dx)})}},AreaManager.prototype.findAreas=function(a,b,c){return _.filter(this.areas,function(d){var e=!0;return c&&(e=b instanceof VCord?c.uy<=d.bounds.top.y&&d.bounds.bottom.y<=c.dy:c.ux<=d.bounds.left.x&&d.bounds.right.x<=c.dx),d.bounds[a]==b&&e})},AreaManager.prototype._drawBounds=function(){var a=this.div;a.find(".dotline").remove(),_.each(this.hCords,function(b){"thick"===b.type&&(console.log(b),$('<div class="dotline dotline-h"></div>').css({left:b.ux+"px",width:b.dx-b.ux+"px",top:b.y-2+"px",height:"5px","background-color":"red"}).appendTo(a))}),_.each(this.vCords,function(b){"thick"===b.type&&(console.log(b),$('<div class="dotline dotline-v"></div>').css({left:b.x-2+"px",width:"5px",top:b.uy+"px",height:b.dy-b.uy+"px","background-color":"red"}).appendTo(a))})},AreaManager.prototype.placeArea=function(a,b,c,d){{var e;a.places}if("full"===a.direction)e=new b(this,d),e.bounds=_.clone(c.bounds);else{var f="left"===a.direction||"right"===a.direction?"v":"h",g=this.findAreas(a.direction,c.bounds[a.direction],c.bounds[a.direction]),h=(Math.min.apply(null,_.map(g,function(a){return"v"===f?a.width():a.height()}))/2|0)*("right"===a.direction||"bottom"===a.direction?-1:1),i="v"===f?c.bounds[a.direction].x+h:c.bounds[a.direction].y+h,j="v"===f?new VCord(this,i,c.bounds.top.y,c.bounds.bottom.y):new HCord(this,c.bounds.left.x,c.bounds.right.x,i);g=this.findAreas(a.direction,c.bounds[a.direction],j),this[f+"Cords"].push(j),e=new b(this,d),e.bounds={left:c.bounds.left,top:c.bounds.top,right:c.bounds.right,bottom:c.bounds.bottom},e.bounds[op[a.direction]]=j,this.changeLinkedCords(c.bounds[a.direction],j),_.each(g,function(b){b.bounds[a.direction]=j,b.recalculatePosition()})}return e.recalculatePosition(),this.areas.push(e),e.afterPlacement(),e},AreaManager.prototype.shiftToNewCord=function(){},AreaManager.prototype.resizeCord=function(a){var b=a instanceof HCord?"h":"v";this.findAreas(b,parent.bounds[split.direction])},AreaManager.prototype.changeLinkedCords=function(a,b){var c,d="number"==typeof b?b:b[b instanceof VCord?"x":"y"];a instanceof VCord?(c=this.findHCords(a,b.uy+1,b.dy-1),_.each(c.left,function(a){a.set("dx",d)}),_.each(c.right,function(a){a.set("ux",d)})):(c=this.findVCords(a,b.ux+1,b.dx-1),_.each(c.top,function(a){a.set("dy",d)}),_.each(c.bottom,function(a){a.set("uy",d)}))},AreaManager.prototype.remove=function(a){var b=this,c=_(["right","bottom","left","top"]).filter(function(b){return"thin"!==a.bounds[b].type}).filter(function(c){return 1===b.findAreas(c,a.bounds[c]).length}).value();if(console.log(c),c.length>0){var d=c[0],e=b.findAreas(op[d],a.bounds[d]);this.changeLinkedCords(a.bounds[d],a.bounds[op[d]]["left"===d||"right"===d?"x":"y"]),_.each(e,function(b){b.bounds[op[d]]=a.bounds[op[d]],b.recalculatePosition()}),a.bounds[d].remove(),a.remove()}else a.remove();_.each(this.areas.concat(this.hCords,this.vCords),function(a){a.div.show()})},AreaManager.prototype.add=function(a,b,c){this.place=getPlace(this.div,!0),this.what=b||Window;new Shadow(a,c||this.dashboard)},AreaManager.prototype.move=function(a,b){var c=new MoveShadow(this,a);c._widget={from:b}},AreaManager.prototype.addArea=function(a){return-1===_.indexOf(this.areas,a)&&this.areas.push(a),a.areaManager=this,console.log(this.areas),this},AreaManager.prototype.removeArea=function(a){return this.areas=_.without(this.areas,a),this},AreaManager.prototype.findPlace=function(a,b,c){var d=c?c.getPlace():this.place;return 0===this.areas.length?{direction:"full",places:[d.clone()]}:d.calculateHalfs({x:a,y:b})};var calculatePlaceForWidgets=function(a){return calculatePlace(_.map(a,function(a){return a.getPlace()}))};AreaManager.prototype.calculatePlace=function(){return calculatePlaceForWidgets(this.areas)},AreaManager.prototype.findLargestWindow=function(){var a=_.reduce(this.areas,function(a,b){var c;return a.square>(c=b.square())?a:{area:b,square:c}},{square:0});return a.area},AreaManager.prototype.toJSON=function(){return{bounds:_.map(this.hCords.concat(this.vCords),function(a){return a.toJSON()}),externalBounds:{left:this.dashboard.bounds.left.toJSON(),top:this.dashboard.bounds.top.toJSON(),right:this.dashboard.bounds.right.toJSON(),bottom:this.dashboard.bounds.bottom.toJSON()},areas:_.map(this.areas,function(a){return a.toJSON()})}};var Area=function(a){this._events={},this.areaManager=a,this.bounds={};var b=document.createElement("div");b.id="area-"+Area._areaCounter++,b.className="window",this.div=$(b),this.div.data("area",this)};Area._areaCounter=0,Area.prototype.width=function(){return this.bounds.right.x-this.bounds.left.x},Area.prototype.height=function(){return this.bounds.bottom.y-this.bounds.top.y},Area.prototype.afterPlacement=function(){},Area.prototype.bindCommonMethods=function(){var a=this;this.div.find(".close").click(function(){a.areaManager.remove(a)})},Area.prototype.square=function(){return(this.bounds.right.x-this.bounds.left.x)*(this.bounds.bottom.y-this.bounds.top.y)},Area.prototype.toggle=function(a){a||!this.areaManager.maximizedArea?(_.each(this.areaManager.areas.concat(this.areaManager.hCords,this.areaManager.vCords),function(a){a.div.hide()}),this.areaManager.maximizedArea={area:this,width:this.activeDashboard().bounds.right.x,height:this.activeDashboard().bounds.bottom.y,w:this.div.width(),h:this.div.height(),left:parseInt(this.div.css("left")),top:parseInt(this.div.css("top"))},this.div.height(this.areaManager.div.height()).width(this.areaManager.div.width()).css({left:0,top:0}).show()):(this.div.width(this.areaManager.maximizedArea.w).height(this.areaManager.maximizedArea.h).css({left:this.areaManager.maximizedArea.left+"px",top:this.areaManager.maximizedArea.top+"px"}),this.activeDashboard().newBound(this.areaManager.maximizedArea.width,"right"),this.activeDashboard().newBound(this.areaManager.maximizedArea.height,"bottom"),delete this.areaManager.maximizedArea,_.each(this.areaManager.areas.concat(this.areaManager.hCords,this.areaManager.vCords),function(a){a.div.show()}))},Area.prototype.recalculatePosition=function(){var a=this,b=new Place(this.bounds.left.x+("thin"!==this.bounds.left.type?4:0),this.bounds.top.y+("thin"!==this.bounds.top.type?4:0),this.bounds.right.x-("thin"!==this.bounds.right.type?3:0),this.bounds.bottom.y-("thin"!==this.bounds.bottom.type?3:0));if(this.div.css(b.toCSS()),this instanceof Window){var c={wPanel:0,wHeader:22,wTab:42}[this.type];_.each(this.dashboards,function(b){b.bounds.right.set("x",a.bounds.right.x-a.bounds.left.x-("thin"!==a.bounds.right.type?3:0)-("thin"!==a.bounds.left.type?4:0)),b.bounds.bottom.set("y",a.bounds.bottom.y-a.bounds.top.y-("thin"!==a.bounds.bottom.type?3:0)-("thin"!==a.bounds.top.type?4:0)-c)})}return this},Area.prototype.remove=function(){this.areaManager.areas=_.without(this.areaManager.areas,this),this.div.remove()},Area.prototype.swap=function(a){var b=this.bounds;return this.bounds=a.bounds,a.bounds=b,this.recalculatePosition(),a.recalculatePosition(),this},Area.prototype.saveData=function(){return null},Area.prototype.toJSON=function(){var a,b=this.saveData();return a={bounds:{left:this.bounds.left.id,right:this.bounds.right.id,top:this.bounds.top.id,bottom:this.bounds.bottom.id},id:this.id},b&&(a.data=b),a};var Widget=function(a){a&&(Area.call(this,a),this.div.addClass("window2").css("background-color","white").html('Я виджет <button class="map">do it!</button><span class="close"></span>'),this.bindCommonMethods(),this.div.appendTo(a.div))};Widget.prototype=new Area,Widget.constructor=Widget;var Window=function(a,b){var c=this;Area.call(this,a),this.parentAreaManager=a,b=b||{},b.icon||(b.icon="tree"),b.title||(b.title="Окно"),this.tabs=[],this._lastTabWidth=minSize,this._aD=null,this.type="wHeader",this.div.addClass("window-header").attr("draggable","false").html('<div class="tabline"><a href="#" class="split"></a><a href="#" class="'+b.icon+'"></a><a href="#" class="close"></a><a href="#" class="min"></a><a href="#" class="max"></a><div class="windowtitle" draggable="true">'+b.title+'</div><ul id="tabs" style="display: none"></ul></div><hr /><div class="window-drop-mask"></div><div class="content"></div>'),this.dom={tabLine:this.div.children(".tabline"),dropMask:this.div.children(".window-drop-mask")},this.dom.tabs=this.dom.tabLine.children("#tabs"),this.bindCommonMethods(),this.bindMouseEvents(),this.div.on("dragover",$.proxy(Window.dragOver,this)),this.dom.dropMask.on("dragleave",$.proxy(Window.dragLeave,this)).on("drop",$.proxy(Window.drop,this)),this.dom.tabLine.children(".windowtitle").on("dragstart",$.proxy(Window._onDragStart,c)).on("dragend",$.proxy(Window._onDragEnd,c)),this.div.appendTo(a.div),this.div.children(".content").css({"background-color":"white",opacity:.8})};Window.prototype=new Area,Window.constructor=Window,Window._onDragStart=function(a){var b=a.originalEvent.dataTransfer;b.setData("type","window"),b.effectAllowed="move",b.setDragImage(this.dom.tabLine.children(".windowtitle").get(0),-15,-5),Window.movingWindow=this},Window._onDragEnd=function(){delete Window.movingWindow};var fadeTimeout=300;Window.drop=function(a){a.stopPropagation(),a.preventDefault(),$(".window-drop-mask").fadeOut(fadeTimeout);var b=a.originalEvent.dataTransfer;switch(b.getData("type")){case"tab":this!==Tab.movingTab.window&&(Tab.movingTab.attachToWindow(this),delete Tab.movingTab);break;case"window":console.log("window drop"),this!==Window.movingWindow&&(Window.movingWindow.swap(this),delete Window.movingWindow);break;default:var c=b.files[0],d=new FileReader,e=this;d.onload=function(a){console.log(a.target),console.log(e),e.activeDashboard().div.css("background","url("+a.target.result+") no-repeat center")},console.log(c),d.readAsDataURL(c)}},Window.dragOver=function(a){Tab.movingTab&&Tab.movingTab.window===this||Window.movingWindow&&Window.movingWindow===this||(a.preventDefault(),a.stopPropagation(),this.dom.dropMask.fadeIn(fadeTimeout))},Window.dragLeave=function(a){a.stopPropagation(),a.preventDefault(),this.dom.dropMask.fadeOut(fadeTimeout)},Window.prototype._widgets=[],Window.registerWidget=function(a){Window.prototype._widgets.push(a)},Window.prototype.toJSON=function(){var a=this.constructor.prototype.toJSON.call(this);return a.tabs=_.map(this.tabs,function(a){var b={dashboard:a.dashboard.areaManager.toJSON()};return b}),a},Window.prototype.activeDashboard=function(){return this._aD||this.dashboards[0]},Window.prototype.addTab=function(a){var b,c;if(1===this.dashboards.length&&this.addTabContainer(),a=a||{},a.tab)c=a.tab,b=c.dashboard,c.window.dashboards=_.without(c.window.dashboards,c.dashboard),c.window.tabs=_.without(c.window.tabs,c),c.window=this,b.areaManager=this.areaManager,b.div.appendTo(this.div);else{var d=$('<div class="content"></div>');d.css("background-color","#"+Math.random().toString(16).substr(2,6)),this.div.append(d),b=new Dashboard(d,{width:d.width()+1,height:d.height()+1}),a.dashboard=b,a.window=this,c=new Tab(a)}return this.dashboards.push(b),this._aD=b,this.dom.tabs.children("li").removeClass("active"),this.tabs.unshift(c),this.tabResize(a.animate),c.makeActive(),a.opacity&&d.css("opacity",a.opacity),a.backgroundColor&&d.css("background-color",a.backgroundColor),c},Window.prototype.addTabContainer=function(){var a=this;this.div.removeClass("window-header").addClass("window-tab"),this.type="wTab",this.dom.tabs.show(),$('<div class="scroll"><span><a href="#"></a></span></div>').click(function(){var b=[];_.each(a.tabs,function(a){a.visible()||b.push({caption:a.title()?a.title():"Вкладка",execute:function(){a.makeActive()}})}),(new CMenu).show(b,this)}).hide().insertAfter(this.dom.tabLine),this.tabResize(),this.recalculatePosition()},Window.prototype.removeTabContainer=function(){this.dom.tabs.hide(),this.div.removeClass("window-tab").addClass("window-header"),this.type="wHeader",console.log(this.dashboards[0]),this.dashboards[0].div.show()},Window.prototype.removeHeader=function(){this.dom.tabLine.hide(),this.type="wPanel"},Window.prototype.addHeader=function(){this.dom.tabLine.show(),this.type="wHeader"},Window.prototype.tabListClick=function(){this.scrollToActive()},Window.prototype.scrollToActive=function(){var a,b=_.indexOf(this.dashboards,this.activeDashboard()),c=0;for(a=0;b-1>a;a++)c+=this.tabs[a].div.width();console.log(c),console.log(this.dom.tabLine.width()),this.dom.tabs.animate({"margin-left":"-"+c+"px"})},Window.prototype.swap=function(a){return this.constructor.prototype.swap.call(this,a).tabResize(),a.tabResize(),this},Window.prototype.tabResize=function(a){if("wTab"===this.type){var b=(this.dom.tabLine,this.dom.tabs.children("li")),c=(this.dom.tabLine.width()-16)/b.length|0;c>100?(this._lastTabWidth=c-2,a===!1?b.width(c-2):b.animate({width:c-2},a),this.div.children(".scroll").hide()):(this.div.children(".scroll").show("slow"),a===!1?b.filter(function(){return!0}).width(this._lastTabWidth):b.filter(function(){return!0}).animate({width:this._lastTabWidth},a))}return this},Window.prototype.recalculateTabs=function(){1===this.tabs.length&&this.removeTabContainer();var a=_.some(this.tabs,function(a){return a.div.hasClass("active")});!a&&this.tabs.length>1&&this.tabs[0].makeActive(),this.tabResize()},Window.prototype.getTabNumber=function(a){return this.tabs.indexOf(a)},Window.prototype.afterPlacement=function(){var a=this,b=this.div.children(".content"),c=new Dashboard(b,{width:b.width()+1,height:b.height()+1});this.dom.tabLine.children(".tree").mousedown(function(){a.addTab()}),this.dashboards=[c];var d=new Tab({dashboard:c,window:this});this.tabs.push(d),Area.prototype.afterPlacement.call(this)},Window.prototype.bindMouseEvents=function(){var a=this;this.div.click(function(){$(".window").removeClass("activeWindow"),a.div.addClass("activeWindow")}),this.dom.tabLine.children(".split").click(function(){(new CMenu).show([{caption:"Создать новое окно рядом",execute:function(b){a.parentAreaManager.add(b,Window,a)}},{caption:"Создать виджет в окне",execute:function(b){a.activeDashboard().areaManager.add(b,Widget)}},{caption:"Создать новую вкладку",execute:function(){a.addTab()}},{caption:"Создать виджет",submenu:_.map(a._widgets,function(b){return{caption:b._name,execute:function(c){a.activeDashboard().areaManager.add(c,b)}}})},{caption:"Прозрачность активного дэшборда",submenu:[{caption:"100%",execute:function(){a.activeDashboard().opacity(1)}},{caption:"80%",execute:function(){a.activeDashboard().opacity(.8)}},{caption:"60%",execute:function(){a.activeDashboard().opacity(.6)}}]}],this)}),this.dom.tabLine.children(".max").click(function(){a.toggle()}),this.dom.tabLine.dblclick(function(){console.log(a)})},Window.prototype.getPlace=function(){return getPlace(this.div)},Window.prototype.fitInWidget=function(){},Window.prototype.on=function(a,b){this._events[a]?this._events[a].push(b):this._events[a]=[b]},Window.prototype.off=function(){},Window.prototype.emit=function(){};var op={left:"right",top:"bottom",right:"left",bottom:"top"},Dashboard=function(a,b){b=b||{},this.icon=b.icon||"searchicon",this.title=b.title||"Дэшборд",this.div=a,this.areaManager=new AreaManager(this);var c=b.width||this.div.width()-1,d=b.height||this.div.height()-1;this.bounds={left:new VCord(this.areaManager,0,0,d,"thin"),top:new HCord(this.areaManager,0,c,0,"thin"),right:new VCord(this.areaManager,c,0,d,"thin"),bottom:new HCord(this.areaManager,0,c,d,"thin")}};Dashboard.prototype.remove=function(){this.div.remove()},Dashboard.prototype.newBound=function(a,b){var c="left"===b||"right"===b?{pos:"x",kind:"v",oldSize:this.bounds.right.x-this.bounds.left.x}:{pos:"y",kind:"h",oldSize:this.bounds.bottom.y-this.bounds.top.y},d=Math.abs(this.bounds[op[b]][c.pos]-a),e=a-this.bounds[b][c.pos],f=d/c.oldSize,g=this;return _.each(this.areaManager[c.kind+"Cords"],function(a){a.set(c.pos,a[c.pos]*f|0)}),g.bounds[b].set(c.pos,a),e?!1:!1},Dashboard.prototype.opacity=function(a){this.div.css("opacity",a)},Dashboard.prototype.backgroundColor=function(a){this.div.css("background-color",a)},Dashboard.prototype._redraw=function(){var a=this.div.width()-1,b=this.div.height()-1;this.areaManager.maximizedArea?this.areaManager.maximizedArea.area.toggle(!0):(this.newBound(a,"right"),this.newBound(b,"bottom"))};var Tab=function(a){var b=this;a=a||{},a.icon=a.icon||"searchicon",a.title=a.title||"Вкладка",this.dashboard=a.dashboard,this.window=a.window,this.div=$('<li class="active" draggable="true" style="width:0;"><div><a href="#" class="'+a.icon+'">'+a.title+'</a></div><span class="close"></span></li>'),this.div.mousedown(function(){b.makeActive()}),this.div.find(".close").click(function(a){b.close(),a.stopPropagation()}),this.div.on("dragstart",$.proxy(Tab._onDragStart,b)).on("dragend",$.proxy(Tab._onDragEnd,b)),this.window.dom.tabs.prepend(this.div)};Tab._onDragStart=function(a){var b=a.originalEvent.dataTransfer;b.setData("type","tab"),b.effectAllowed="move",b.setDragImage(this.div.children("div").children("a").get(0),-15,-5),Tab.movingTab=this,this.div.css("backgroundColor","red")},Tab._onDragEnd=function(){this.div.css("backgroundColor",""),delete Tab.movingTab},Tab.prototype.icon=function(a){var b=this.div.children("div").children("a");return a?(b.removeClass().addClass(a),this):b.attr("class")},Tab.prototype.title=function(a){var b=this.div.children("div").children("a");return a?(b.text(a),this):b.text()},Tab.prototype.makeActive=function(a){if(this.window.dom.tabs.children("li").removeClass("active"),_.each(this.window.dashboards,function(a){a.div.hide()}),this.div.addClass("active"),!this.visible()){var b=this.window.tabs.splice(this.window.getTabNumber(this),1)[0];this.window.tabs.unshift(b),a===!1?this.div.prependTo(this.window.dom.tabs):this.div.width(0).prependTo(this.window.dom.tabs).animate({width:this.window._lastTabWidth},a)}this.window._aD=this.dashboard,this.dashboard.div.show()},Tab.prototype.visible=function(){return 18===this.div.position().top},Tab.prototype.attachToWindow=function(a){var b=this.window;Tab.movingTab.div.appendTo(a.dom.tabs),a.addTab({tab:Tab.movingTab}),b.recalculateTabs()},Tab.prototype.close=function(){var a=this;this.div.animate({width:"toggle"},function(){this.remove(),a.window.dashboards=_.without(a.window.dashboards,a.dashboard),a.dashboard.remove(),a.window.tabs=_.without(a.window.tabs,a),a.window.recalculateTabs()})},window.Window=Window,window.Dashboard=Dashboard,window.Shadow=Shadow,window.AreaManager=AreaManager,window.Place=Place,window.VCord=VCord,window.HCord=HCord,window.Widget=Widget,window.Area=Area,function(a,b){function c(a,b,c,d){return b&&(b=b.replace(/"/,'"')),'<img src="'+q+a+(-1===a.search(/\.(gif|jpg|jpeg)$/i)?".png":"")+'" '+(d?"":'width="16" height="16"')+' alt="'+(b?b:"img")+'" '+(b?'title="'+b+'"':"")+(c?' style="'+c+'"':"")+" />"}function d(b){var c=a.cmenu.c.length,d={cn:"cmenu",id:c,jq:a('<div iuid="'+c+'" class="cmenu"></div>'),r:!1};return d[a.isFunction(b)?"f":"a"]=b,a.cmenu.c[c]=d,d}function e(b){for(var c,d=[];b;){if(c=a(b),!c.hasClass(s)){d.push(b);break}b.cmenu=a.cmenu.get_menu(parseInt(c.parent().attr("iuid"),10)),b.cmenu_item=b.cmenu.a[c.attr("item_id")],d.push(b),b=b.cmenu.caller}return d.reverse()}function f(a,b){if(a.offsetParent&&a.offsetParent!==b){var c=f(a.offsetParent,b);return c.x+=a.offsetLeft,c.y+=a.offsetTop,c}return{x:a.offsetLeft,y:a.offsetTop}}function g(){if(a.cmenu.lockHiding)return!1;a().unbind("click",g),a.cmenu.hideBinded=!1;for(var b=a.cmenu.c.length,c=0;b>c;c++)a.cmenu.hide_menu(a.cmenu.c[c])}function h(a,b){var c=!1;if("object"==typeof a&&(c=!0,a=a.id),"number"!=typeof a)return"";switch(b){case"click":default:return'onclick="$.cmenu.show('+a+',this);$.cmenu.lockHiding=true;" onmouseout="$.cmenu.lockHiding=false;"';case"hovertimeout":return'onmouseover="var t=this;$.cmenu.to=setTimeout(function(){$.cmenu.show('+a+',t);$.cmenu.lockHiding=true;},200);" onmouseout="clearTimeout($.cmenu.to);$.cmenu.lockHiding=false;"'}}function i(b){if(!a.isFunction(b.f))return!0;if("object"!=typeof b.caller)return!1;var c=b.f(b);return"object"==typeof c?(b.a=c,b.r=!1):b.r=!c,!0}function j(b){return b.async?b.a?(b.r=!1,!0):(b.done=function(){b.v=!1,a.cmenu.show(b,b.caller)},!1):!0}function k(a){return a.r?!1:(a.r=!0,!0)}function l(b){return b.visible!==o&&!b.visible||b.acid!==o&&a.inArray(b.acid,[])}function m(b,d,e){var f=b.a[d];if("-"===f)return"<hr/>";if(f.constructor===Array&&(f=new MenuItem(f[0],f[1],f[2],f[3]),b.a[d]=f),b.a[d].parent=b.parent_item,l(f))return"";!f.submenu||f.submenu.cn&&"cmenu"===f.submenu.cn||(f.submenu=a.cmenu.get_menu(f.submenu));var g=f.caption;return e&&g===e&&(g="<strong>"+f.caption+"</strong>"),'<div class="cmenu-item" item_id="'+d+'" '+(f.disabled?'style="color:#808080;" ':'onclick="$.cmenu.exec(this);" '+(f.submenu?h(f.submenu,"hovertimeout"):' onmouseover="$.cmenu.to=setTimeout(function(){var m = $.cmenu.get_menu('+b.id+');m && m.sub && $.cmenu.hide_menu(m.sub);},300);" onmouseout="clearTimeout($.cmenu.to);" '))+'><span class="cmenu-icon">'+(f.icon?c(f.icon," "):"")+'</span><span class="cmenu-title"> '+g+'</span><span class="sprite-icon '+(f.submenu?"cmenu-has-submenu":"")+'"></span></div>'}function n(a){if(!i(a)||!j(a)||!k(a))return!1;if("radio"===a.type)var b=a.get();else b=!1;var c='<div class="cmenu-left-line"></div>';for(var d in a.a)a.a[d]&&(c+=m(a,d,b));a.jq.html(c)}var o,p,q="./images/",r="cmenuItemWithSub",s="cmenuItem";b.MenuItem=function(a,b,c,d){-1!==a.search(/^!/)&&(this.disabled=!0,a=a.substr(1)),this.caption=a,this.icon=b,this.execute=c,this.submenu=d},a.cmenu={c:[],exec:function(c){c=a(c);var d=c.attr("item_id"),e=c.parent().attr("iuid"),f=a.cmenu.c[e];return f?f.a&&f.a[d]?"radio"===f.type?(f.set(f.a[d].caption),n(f),!1):void(a.isFunction(f.a[d].execute)&&!f.a[d].disabled&&(f.a[d].execute.apply(b,[f.a[d],f,f.p]),g())):(alert("Action not found"),!1):(alert("Menu not found"),!1)},get_menu:function(a){return-1===(typeof a).search(/function|object|undefined/)?this.c[a]:d(a)},hide_menu:function(b){b&&b.v&&(b.v=!1,this.hide_menu(b.sub),b.caller&&a(b.caller).removeClass(r),b.jq.remove())},show:function(c,d,h){if("object"!=typeof c&&(c=this.get_menu(c)),"undefined"==typeof h&&(h="left"),c.v&&c.caller===d)return!1;this.hideBinded||(this.hideBinded=!0,a().bind("click",g));var i=c.caller;c.caller=d,c.sub&&this.hide_menu(c.sub);var j=a(d);if(j.hasClass(s)&&!j.hasClass(r)){j.addClass(r);var k=a.cmenu.get_menu(parseInt(a(d.parentNode).attr("iuid"),10));k&&(k.sub&&(k.sub===c?a(i).removeClass(r):(a.cmenu.hide_menu(k.sub),a.cmenu.to&&clearTimeout(a.cmenu.to)&&delete a.cmenu.to)),k.sub=c,c.parentMenu=k)}c.p=e(d),c.parent_item=c.p[c.p.length-1].cmenu_item,n(c),c.jq[0].offsetParent!==c.p[0].offsetParent&&c.jq.appendTo(p),"none"===c.jq.css("display")&&c.jq.show();var l=c.jq[0].offsetParent,m=c.jq[0].offsetWidth,o=c.jq[0].offsetHeight,q=0,t=0;"number"==typeof b.innerWidth?(q=b.innerWidth,t=b.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)&&(q=document.documentElement.clientWidth,t=document.documentElement.clientHeight);var u=0,v=0;"number"==typeof b.pageYOffset?(u=b.pageXOffset,v=b.pageYOffset):document.body&&(document.body.scrollLeft||document.body.scrollTop)?(u=document.body.scrollLeft,v=document.body.scrollTop):document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)&&(u=document.documentElement.scrollLeft,v=document.documentElement.scrollTop);var w=t+v,x=q+u,y=f(d,l);"left"==h?(a(d).hasClass("cmenu-item")?c.jq.css("left",l.offsetLeft+y.x+d.offsetWidth+m>x?y.x-m:y.x+d.offsetWidth):p.css("left",l.offsetLeft+y.x+d.offsetWidth+m>x?y.x-m:y.x+d.offsetWidth),a(d).hasClass("cmenu-item")?c.jq.css("top",l.offsetTop+y.y+o>w?y.y-o+d.offsetHeight+2:y.y+1):p.css("top",l.offsetTop+y.y+o>w?y.y-o+d.offsetHeight+2:y.y+1)):(c.jq.css("left",y.x),c.jq.css("top",y.y+1+d.offsetHeight)),c.v=!0}},a.fn.bindMenu=function(b,c,d){return a("#menuOuter").length||a("body").append('<div id="menuOuter"></div>'),p=a("#menuOuter"),p.css("position","absolute"),1===arguments.length&&(c=b,b="mousedown"),c.jq||(c=a.cmenu.get_menu(c)),this.each(function(){a(this).bind(b,function(){return g(),a.cmenu.lockHiding=!0,a.cmenu.show(c,this,d),!1}).bind("mouseout",function(){a.cmenu.lockHiding=!1}).bind("click",function(){return!1})})},a(document).click(function(){g()})}(jQuery,this),CMenu.prototype.show=function(a,b,c){var d=this;if(c=c||window.event,b||void 0!==c){if(b){var e=$(b).offset();
d._left=e.left+b.offsetWidth,d._top=e.top}else b=c.target,d._left=c.clientX,d._top=c.clientY;this.parentNode=b,this.jD=$('<div class="cmenu" style="left: '+d._left+"px; top: "+d._top+'px;display:none;"></div>').data("CMenu",this).appendTo("body").mouseout(function(){return d.in=!1,clearTimeout(d.to),d.to=setTimeout(function(){var a=d,b=!1;for(a.remove();a.parent;){if(a.in){b=!0;break}a.parent.jD.find(".itemSelected").removeClass("itemSelected"),b||(a=a.parent)}a.remove()},200),!1}),this.jD.mouseover(function(){$(this).data("CMenu").in=!0,d.in=!0,d.parent&&clearTimeout(d.parent.to),clearTimeout(d.to)}),this.draw(a)}},CMenu.prototype.draw=function(a,b){b||(b=this.jD);var c=this,d=WinSize();$('<div class="cmenu-left-line"></div>').appendTo(b);for(var e in a)a[e].id=e,a[e].type||(a[e].type="text"),this.items[e]=new MenuItem(a[e].type,c).html(a[e]),b.append(this.items[e]);parseFloat(c.jD.css("left"))+c.jD.outerWidth()>d.winWidth&&c.jD.css("left",c._left-c.jD.outerWidth()+"px"),parseFloat(c.jD.css("top"))+c.jD.outerHeight()>d.winHeight&&c.jD.css("top",c._top+$(c.parentNode).outerHeight()-c.jD.outerHeight()+"px"),c.jD.show()},CMenu.prototype.remove=function(){if(this.in!==!0){this.submenu&&this.submenu.remove();for(var a in this.items)this.items[a].remove();this.jD&&this.jD.remove()}},CMenu.prototype.item_mouseover=function(a){var b=$(a).parent().data("CMenu");clearTimeout(b.to),b.parent&&clearTimeout(b.parent.to),b.submenu&&b.submenu.remove(),$(b.parentNode).hasClass("cmenu-item")&&$(b.parentNode).addClass("itemSelected")};var MenuItem=function(a,b){var c=a[0].toUpperCase()+a.slice(1);return this.parent=b,new MenuItem[c](a,b)};MenuItem.Text=function(){return this},MenuItem.Text.prototype.html=function(a){if(""==a.caption)return"";var b=(this.parent,$('<div class="cmenu-item" item_id="'+a.id+'"></div>')),c="";if(a.disabled?b.css("color","#808080"):a.submenu||b.click(function(b){a.execute(b),$(this).parent().data("CMenu").jD.mouseout()}),a.icon){switch(c='<span class="'+a.icon.class+'">',a.icon.type){case"img":c+='<img class="sprite-icon" title=" " alt=" " src="'+a.icon.path+'" />';break;case"sprite":c+='<span class="sprite-cmenu '+a.icon.path+'"></span>'}c+="</span>"}else c+='<span style="width:16px; height:16px; display: inline-block;" ></span>';return c+='<span class="cmenu-title"> '+a.caption+"</span>",a.submenu?(c+=(a.disabled?"":'<span class="cmenu-has-submenu"></span>')+"</div>",b.data("Sub_JSON",a.submenu),b.mouseover(function(){var b=$(this).parent().data("CMenu");b.item_mouseover(this),a.disabled||(b.submenu=new CMenu,b.submenu.parent=b,b.submenu.show($(this).data("Sub_JSON"),this))})):b.mouseover(function(){$(this).parent().data("CMenu").item_mouseover($(this))}),b.html(c),b},MenuItem.Checkbox=function(){return this},MenuItem.Checkbox.prototype.html=function(a){if(""==a.caption)return"";var b=(this.parent,$('<div class="cmenu-item" item_id="'+a.id+'"></div>')),c="";if(a.disabled&&b.css("color","#808080"),a.icon){switch(c='<span class="'+a.icon.class+'">',a.icon.type){case"img":c+='<img class="sprite-icon" title=" " alt=" " src="'+a.icon.path+'" />';break;case"sprite":c+='<span class="sprite-cmenu '+a.icon.path+'"></span>'}c+="</span>"}else c+='<span style="width:16px; height:16px;display: inline-block;" ></span>';return c+='<div class="cmenu-title" style="display: inline-block"><input class="cmenu-title cmenu-checkbox" '+(a.disabled?"disabled":"")+(a.check?"checked":"")+' type="checkbox" />',c+='<span class="cmenu-title">'+a.caption+"</span></div>",b.mouseover(function(){$(this).parent().data("CMenu").item_mouseover(this)}),b.html(c),b};